"use strict";var view=function(){var e={},t={updating:false},i,n,r,a,o,s,l,d,c;i=function(e){if(typeof e==="boolean"){t.updating=e}return t.updating};e.updating=i;n=function(e){d3.select("#working_icon").classed("invisible",!e)};e.loading=n;r=function(e,t){d3.select("#working_icon").classed("invisible",!t);d3.selectAll(e+" .calc").classed("hidden",!t);d3.selectAll(e+" .calc-done").classed("hidden",t)};e.calculating=r;a=function(e){d3.select("div#error").classed("hidden",false).append("p").text(e);this.loading(false);VIS.error=true};e.error=a;o=function(e){d3.select("div#warning").classed("hidden",false).append("p").text(e)};e.warning=o;s=function(){var e=t.tooltip;if(e){return e}e={offset:VIS.tooltip.offset};e.div=d3.select("body").append("div").attr("id","tooltip").classed("bar_tooltip",true);e.container=d3.select("body").node();e.div.append("p");e.update_pos=function(){var e=d3.mouse(this.container);this.div.style({left:e[0]+this.offset.x+"px",top:e[1]+this.offset.y+"px",position:"absolute"})};e.text=function(e){this.div.select("p").text(e)};e.show=function(){this.div.classed("hidden",false)};e.hide=function(){this.div.classed("hidden",true)};t.tooltip=e;return e};e.tooltip=s;l=function(e,t){e.append("td").classed("weight",true).append("div").classed("proportion",true).style("margin-left",function(e){return d3.format(".1%")(1-t(e))}).append("span").classed("proportion",true).html("&nbsp;")};e.append_weight_tds=l;d=function(e,t){var i;if(!VIS.svg){VIS.svg=d3.map()}if(VIS.svg.has(e)){return VIS.svg.get(e)}i=c(d3.select(e),t);VIS.svg.set(e,i);return i};e.plot_svg=d;c=function(e,t){return e.append("svg").attr("width",t.w+t.m.left+t.m.right).attr("height",t.h+t.m.top+t.m.bottom).append("g").attr("transform","translate("+t.m.left+","+t.m.top+")")};e.append_svg=c;return e}();"use strict";var bib={};bib.doc_author=function(e){var t,i,n;if(e.authors.length>0){t=e.authors[0].replace(/,/g,"").split(" ");i=t.pop();if(t.length>=2&&i.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){n=t.pop().replace(/_$/,"");i=", "+i.replace(/\W*$/,"")}else{n=i;i=""}n+=", "+t.join(" ")+i;if(e.authors.length>1){if(e.authors.length>2){n+=", ";n+=e.authors.slice(1,e.authors.length-1).join(", ")}n+=", and "+e.authors[e.authors.length-1]}}else{n="[Anon]"}return n};bib.sort=function(e,t,i,n,r){var a=[],o,s,l,d,c,u,p,f,_=function(e){return e.id},w=[];if(t==="decade"){s=function(t){return Math.floor(e.meta(t).date.getUTCFullYear()/10).toString()+"0s"}}else if(t==="year"){s=function(t){return e.meta(t).date.getUTCFullYear()}}else if(t==="journal"){s=function(t){return e.meta(t).journaltitle}}else if(t==="issue"){s=function(t){var i=e.meta(t),n,r;n=i.journaltitle;n+="_"+d3.format("05d")(i.volume);if(String(i.issue).search("S")!==-1){r=+i.issue.replace("S","")*10+5}else{r=+i.issue*10}n+="_"+String(r);return n}}else{s=function(t){return bib.doc_author(e.meta(t)).replace(/^\W*/,"")[0].toUpperCase()}}if(i==="date"){l=function(t){return+e.meta(t).date}}else if(i==="journal"){l=function(t){var i=e.meta(t),n=i.journaltitle;n+=d3.format("05d")(i.volume);n+=d3.format("05d")(i.issue===""?0:i.issue.replace(/\/.*$/,""));if(i.pagerange.search(/^\d/)!==-1){n+=d3.format("05d")(i.pagerange.match(/^(\d+)/)[1])}else{n+=i.pagerange}return n}}else{l=function(t){return bib.doc_author(e.meta(t))+e.meta(t).title}}d=n?d3.ascending:d3.descending;c=r?d3.ascending:d3.descending;o=d3.range(e.n_docs()).map(function(e){return{id:e,major:s(e),minor:l(e)}}).sort(function(e,t){return d(e.major,t.major)||c(e.minor,t.minor)||d3.ascending(e.id,t.id)});for(p=0,u="";p<o.length;p+=1){if(o[p].major!==u){w.push(p);a.push({heading:o[p].major});u=o[p].major}}w.shift();w.push(o.length);for(p=0,f=0;p<w.length;p+=1){a[p].docs=o.slice(f,w[p]).map(_);f=w[p]}return a};bib.sort.validate=function(e){var t=e;if(VIS.bib.keys.major.indexOf(e.major)===-1){t.major=undefined}if(VIS.bib.keys.minor.indexOf(e.minor)===-1){t.minor=undefined}if(e.dir!=="up"&&e.dir!=="down"){t.dir=undefined}return t};bib.sort.dir=function(e){var t={major:true,minor:true};if(e.dir==="up"){return t}if(e.dir==="down"){t.major=false;if(e.major==="decade"||e.major==="year"||e.major==="issue"){t.minor=e.minor!=="date"&&e.minor!=="journal"}else if(e.major==="alpha"||e.major==="journal"){t.minor=e.minor!=="alpha"}else{t.minor=true}}return t};bib.author=function(e){var t,i,n;if(e.authors.length>0){t=e.authors[0].replace(/,/g,"").split(" ");i=t.pop();if(t.length>=2&&i.search(/^(\d|Jr|Sr|[IXV]+$)/)!==-1){n=t.pop().replace(/_$/,"");i=", "+i.replace(/\W*$/,"")}else{n=i;i=""}n+=", "+t.join(" ")+i;if(e.authors.length>1){if(e.authors.length>2){n+=", ";n+=e.authors.slice(1,e.authors.length-1).join(", ")}n+=", and "+e.authors[e.authors.length-1]}}else{n="[Anon]"}return n};bib.citation=function(e){var t=bib.doc_author(e),i,n;t=t.replace(/\.?$/,". ");i=e.title.replace(/“/g,"‘").replace(/”/g,"’").replace(/(^|[-\u2014/(\[{\u2018\s])"/g,"$1‘").replace(/"/g,"’").replace(/'/g,"’").replace(/ <br><\/br>/g,". ");t+="“"+i+".”";t=t.replace(/’\./g,".’");t+=" <em>"+e.journaltitle+"</em> ";t+=e.volume;if(e.issue){t+=", no. "+e.issue}t+=" (";n=e.date.getUTCMonth();if(n===0||n===11){t+="Winter "}else if(n===2||n===3){t+="Spring "}else if(n===5||n===6){t+="Summer "}else if(n===8||n===9){t+="Autumn "}t+=e.date.getUTCFullYear()+"): ";t+=e.pagerange+".";t=t.replace(/\.\./g,".");t=t.replace(/_/g,",");t=t.replace(/\t/g,"");return t};bib.parse=function(e){var t=e[2].trim(),i=new Date(e[6].trim());return{doi:e[0].trim(),title:e[1].trim(),authors:t===""?[]:t.split(VIS.bib.author_delimiter),journaltitle:e[3].trim(),volume:e[4].trim(),issue:e[5].trim(),date:i,pagerange:e[7].trim().replace(/^p?p\. /,"").replace(/-/g,"–"),special:e[8].trim()}};"use strict";var model;model=function(e){var t=e||{},i={},n,r,a,o,s,l,d,c,u,p,f,_,w,v,m,h,g,y,b,S,I,V,x,k,A,j;t.ready={};t.worker=new Worker("js/worker.min.js");t.worker.fs=d3.map();t.worker.onmessage=function(e){var i=t.worker.fs.get(e.data.what);if(i){i(e.data.result)}};t.worker.callback=function(e,i){t.worker.fs.set(e,i)};n=function(e){if(e){t.info=e;t.issues=d3.map();t.info.issues.forEach(function(e){t.issues.set(e[0],{title:e[1],url:e[2]})})}return t.info};i.info=n;r=function(){var e;if(t.n_docs!==undefined){e=t.n_docs}else if(t.meta){e=t.meta.length}return e};i.n_docs=r;a=function(){return!!t.ready.dt};i.has_dt=a;o=function(e,i){if(!t.tw){return undefined}if(e===undefined){return t.tw}if(i===undefined){return t.tw[e]}return t.tw[e].get(i)};i.tw=o;s=function(){return t.n};i.n=s;l=function(){if(!this.tw()){return undefined}return t.tw[0].keys().length};i.n_top_words=l;d=function(e){if(!t.total_tokens){t.worker.callback("total_tokens",function(i){t.total_tokens=i;e(i)});t.worker.postMessage({what:"total_tokens"})}else{e(t.total_tokens)}};i.total_tokens=d;c=function(e,i){var n=isFinite(e)?e:"all";t.worker.callback("topic_total/"+n,i);t.worker.postMessage({what:"topic_total",t:n})};i.topic_total=c;u=function(e){if(!t.alpha){return undefined}return isFinite(e)?t.alpha[e]:t.alpha};i.alpha=u;p=function(e){if(!t.meta){return undefined}if(typeof e==="number"){return t.meta[e]}if(e===undefined){return t.meta}return e.map(function(e){return t.meta[e]})};i.meta=p;f=function(e){var n=e,r;if(!t.meta||!t.issues){return undefined}if(typeof e==="number"){r=t.meta[e].special;return r===""?undefined:t.issues.get(r)}if(e===undefined){n=d3.range(i.n_docs())}return n.map(function(e){var i=t.meta[e].special;return i===""?undefined:t.issues.get(i)})};i.special_issue=f;m=function(e){if(!t.years){return undefined}return t.years.has(e)};i.valid_year=m;_=function(){var e;if(t.vocab){return t.vocab}if(!this.tw()){return undefined}e=d3.set();this.tw().map(function(t){t.keys().map(function(t){e.add(t)})});t.vocab=e.values().sort();return t.vocab};i.vocab=_;w=function(e){if(!t.topic_scaled){return undefined}if(e===undefined){return t.topic_scaled}return t.topic_scaled[e]};i.topic_scaled=w;h=function(e,i){var n=e===undefined?"all":e,r=i;if(n==="all"){r=function(e){i(d3.map(e))}}t.worker.callback("yearly_total/"+n,r);t.worker.postMessage({what:"yearly_total",y:n})};i.yearly_total=h;v=function(e,i){var n=e===undefined?"all":e,r;if(n==="all"){r=function(e){i(e.map(d3.map))}}else{r=function(e){i(d3.map(e))}}t.worker.callback("topic_yearly/"+n,r);t.worker.postMessage({what:"topic_yearly",t:n})};i.topic_yearly=v;g=function(e,n,r,a){var o=n,s=a;if(r!==undefined){o=this.n_docs();s=function(e){var t=e.filter(function(e){return i.meta(e.doc).date.getUTCFullYear()===+r});return a(utils.shorten(t,n))}}t.worker.callback("topic_docs/"+e+"/"+o,s);t.worker.postMessage({what:"topic_docs",t:e,n:o})};i.topic_docs=g;b=function(e,i,n){t.worker.callback("doc_topics/"+e+"/"+i,n);t.worker.postMessage({what:"doc_topics",d:e,n:i})};i.doc_topics=b;y=function(e,t){var n=t||this.n_top_words(),r;if(e===undefined){return d3.range(this.n()).map(function(e){return i.topic_words(e,t)})}r=this.tw(e).entries();r.sort(function(e,t){return d3.descending(e.value,t.value)||d3.ascending(e.key,t.key)});return utils.shorten(r,n,function(e,t){return e[t].value}).map(function(e){return{word:e.key,weight:e.value}})};i.topic_words=y;S=function(e,t){var i,n,r,a=t||this.n_top_words(),o=[],s=function(e){return e.values().reduce(function(e,t){return t>r?e+1:e},0)};for(i=0;i<this.n();i+=1){n=this.tw(i);if(n.has(e)){r=n.get(e);o.push({topic:i,rank:s(n)})}}o.sort(function(e,t){return d3.ascending(e.rank,t.rank)||d3.ascending(e.topic,t.topic)});return utils.shorten(o,a,function(e,t){return e[t].rank})};i.word_topics=S;I=function(e,t){var i,n,r=[];for(i=0;i<this.n();i+=1){n=this.topic_yearly(i);r.push({topic:i,weight:n.get(e)||0})}r.sort(function(e,t){return d3.descending(e.weight,t.weight)||d3.ascending(e.topic,t.topic)});return utils.shorten(r,t)};i.year_topics=I;V=function(e){if(t.info.names){return t.info.names[e+1]}return undefined};i.topic_name=V;k=function(e){var i;if(typeof e!=="string"){return}i=JSON.parse(e);t.alpha=i.alpha;t.tw=i.tw.map(function(e){var t=d3.map();e.words.map(function(i,n){t.set(i,e.weights[n])});return t});if(!t.n){t.n=t.alpha.length}};i.set_tw=k;x=function(e,i){if(typeof e!=="string"){i(false)}t.worker.callback("set_dt",function(e){t.ready.dt=e;i(e)});t.worker.postMessage({what:"set_dt",dt:JSON.parse(e)})};i.set_dt=x;A=function(e){var i,n=[];if(typeof e!=="string"){return}i=e.replace(/^\n*/,"").replace(/\n*$/,"\n");t.start_date=new Date(1e3,0,1);t.end_date=new Date;t.meta=d3.csv.parseRows(i,function(e,i){var r=bib.parse(e);n.push(r.date.getUTCFullYear());t.start_date=r.date<t.start_date?r.date:t.start_date;t.end_date=r.date>t.end_date?r.date:t.end_date;return r});t.worker.callback("set_doc_years",function(e){t.ready.doc_years=e});t.worker.postMessage({what:"set_doc_years",doc_years:n});t.years=d3.set(n)};i.set_meta=A;j=function(e){var i;if(typeof e!=="string"){return}i=e.replace(/^\n*/,"").replace(/\n*$/,"\n");t.topic_scaled=d3.csv.parseRows(i,function(e){return e.map(parseFloat)})};i.set_topic_scaled=j;return i};"use strict";view.about=function(e){var t=e||"intro",i=d3.select("#about_view #about_"+t);if(i.empty()){i=d3.select("#about_intro");t="intro"}d3.selectAll("#discussion_text > div").classed("hidden",true);i.classed("hidden",false);i.node().scrollIntoView();d3.selectAll("#about_contents li").classed("selected",false);d3.select("#about_contents_"+t).classed("selected",true);return true};"use strict";view.bib=function(e){var t=e.ordering.map(function(t){var i=t;t.key=t.heading+"_"+e.minor+"_"+e.dir;return i}),i;d3.selectAll("select#select_bib_sort option").each(function(){this.selected=this.value===e.major+"_"+e.minor});d3.selectAll("select#select_bib_dir option").each(function(){this.selected=this.value===e.dir});d3.select("select#select_bib_sort").on("change",function(){var e;d3.selectAll("#select_bib_sort option").each(function(){if(this.selected){e=this.value}});set_view("/bib/"+e.replace(/_/,"/"))});d3.select("select#select_bib_dir").on("change",function(){var t;d3.selectAll("#select_bib_dir option").each(function(){if(this.selected){t=this.value}});set_view("/bib/"+e.major+"/"+e.minor+"/"+t)});d3.select("a#bib_sort_dir").attr("href","#/bib/"+e.major+"/"+e.minor+"/"+(e.dir==="up"?"down":"up"));d3.select("#bib_headings a.top_link").on("click",function(){d3.event.preventDefault();window.scrollTo(0,0)});i=d3.select("#bib_view #bib_headings ul").selectAll("li").data(t,function(e){return e.key});i.enter().append("li").append("a");i.exit().remove();VIS.bib.keys.major.forEach(function(t){i.classed(t,e.major===t)});i.selectAll("a").attr("href",function(e){return"#"+view.bib.id(e.heading)}).on("click",function(e){d3.event.preventDefault();d3.select("#"+view.bib.id(e.heading)).node().scrollIntoView()}).text(function(t){return e.major==="issue"?view.bib.decode_issue(t.heading,false):t.heading});if(e.major==="issue"){i.classed(VIS.special_issue_class,function(t){return!!e.specials[t.docs[0]]})}view.bib.render({ordering:t,citations:e.citations,specials:e.specials,major:e.major});return true};view.bib.render=function(e){var t,i,n;view.loading(true);t=d3.select("#bib_main").selectAll("div.section").data(e.ordering,function(e){return e.key});i=t.enter().append("div").classed("section",true).attr("id",function(e){return view.bib.id(e.heading)});if(e.major==="issue"){i.append("h2").classed(VIS.special_issue_class,function(t){return!!e.specials[t.docs[0]]}).html(function(t){var i=view.bib.decode_issue(t.heading,true),n=t.docs[0];if(e.specials[n]){i+='. <a href="'+e.specials[n].url+'">';i+=e.specials[n].title;i+="</a>"}return i})}else{i.append("h2").html(function(e){return e.heading})}i.append("ul");t.exit().remove();n=t.select("ul").selectAll("li").data(function(e){return e.docs});n.enter().append("li");n.exit().remove();n.html(function(t){var i='<a href="#/doc/'+t+'">';i+=e.citations[t];i+="</a>";return i}).classed(VIS.special_issue_class,function(t){return!!e.specials[t]});view.loading("false")};view.bib.id=function(e){return"bib_"+String(e).replace(/\W/g,"_")};view.bib.decode_issue=function(e,t){var i,n,r,a;r=e.split("_");i=+r[1];if(+r[2]%10===0){n=+r[2]/10}else{n=(+r[2]-5)/10;n=String(n)+"S"}if(t){a="<em>Signs</em> "+i;a+=", no. "+n}else{a=String(i);a+="."+n}return a};"use strict";view.doc=function(e){var t=d3.select("div#doc_view"),i=e.total_tokens,n=e.topics,r;d3.select("#doc_view_main").classed("hidden",false);t.select("h2#doc_header").html(bib.citation(e.meta));if(e.special){t.select("#doc_remark .special_issue a").attr("href",e.special.url).text(e.special.title)}t.select("#doc_remark .special_issue").classed("hidden",!e.special);t.select("#doc_remark .token_count").text(e.total_tokens);t.select("#doc_remark a.jstor").attr("href",view.doc.uri(e.meta));r=t.select("table#doc_topics tbody").selectAll("tr").data(n);r.enter().append("tr");r.exit().remove();r.selectAll("td").remove();r.append("td").append("a").attr("href",function(e){return topic_link(e.topic)}).text(function(t,i){return view.topic.label(t.topic,e.words[i],e.names[i],true)});r.on("click",function(e){set_view(topic_hash(e.topic))});view.append_weight_tds(r,function(e){return e.weight/i});r.append("td").classed("td-right",true).text(function(e){return VIS.percent_format(e.weight/i)});r.append("td").classed("td-right",true).text(function(e){return e.weight})};view.doc.uri=function(e){return"http://www.jstor.org"+"/stable/"+e.doi};"use strict";view.model=function(){return true};"use strict";view.model.list=function(e){var t,i,n,r=d3.sum(e.sums),a,o,s,l,d=e.yearly[0].keys();t=d3.select("#model_view_list table tbody").selectAll("tr");if(!VIS.ready.model_list){d3.select("th#model_view_list_year a").text(d3.min(d)+"—"+d3.max(d));t=t.data(d3.range(e.yearly.length)).enter().append("tr");t.on("click",function(e){set_view(topic_hash(e))});t.classed("hidden_topic",function(t){return e.topic_hidden[t]});i=t.append("td").append("div").classed("spark",true);view.append_svg(i,VIS.model_view.list.spark).each(function(t){view.topic.yearly_barplot({svg:d3.select(this),t:t,yearly:e.yearly[t],axes:false,clickable:false,spec:VIS.model_view.list.spark})});t.append("td").append("a").classed("topic_words",true);t.selectAll("a.topic_words").append("span").classed("name",true);t.selectAll("a.topic_words").append("span").classed("words",true);n=d3.max(e.sums);view.append_weight_tds(t,function(t){return e.sums[t]/n});t.append("td").text(function(t){return VIS.percent_format(e.sums[t]/r)});VIS.ready.model_list=true}t.selectAll("td a.topic_words").attr("href",topic_link).text(function(t){return view.topic.label(t,e.words[t],e.names[t],true)});if(!VIS.last.model_list){VIS.last.model_list={}}s=e.sort||VIS.last.model_list.sort||"topic";l=e.dir||(s===VIS.last.model_list.sort?VIS.last.model_list.dir:"up")||"up";a=d3.range(e.yearly.length);if(s==="words"){a=a.map(function(t){if(e.names[t]){return e.names[t]}return e.words[t].reduce(function(e,t){return e+" "+t.word},"")})}else if(s==="frac"){a=a.map(function(t){return-e.sums[t]/r})}else if(s==="year"){a=e.yearly.map(function(e){var t,i=0;e.forEach(function(e,n){if(n>i){t=e;i=n}});return t})}if(l==="down"){o=function(e,t){return d3.descending(a[e],a[t])||d3.descending(e,t)}}else{o=function(e,t){return d3.ascending(a[e],a[t])||d3.ascending(e,t)}}VIS.last.model_list.sort=s;VIS.last.model_list.dir=l;t.sort(o).order();d3.selectAll("#model_view_list th.sort").classed("active",function(){return!!this.id.match(s)}).each(function(){var e="#/"+this.id.replace(/_(view_)?/g,"/");if(this.id.match(s)){e+=l==="down"?"/up":"/down"}d3.select(this).select("a").attr("href",e)}).on("click",function(){set_view(d3.select(this).select("a").attr("href").replace(/#/,""))});return true};"use strict";view.model.plot=function(e){var t,i,n,r,a,o,s,l,d,c,u,p,f,_,w,v=e.topics,m=e.topics.length;t={w:VIS.model_view.w,h:Math.floor(VIS.model_view.w/VIS.model_view.aspect),m:{left:0,right:0,top:0,bottom:0}};i=view.plot_svg("#model_view_plot",t);r=VIS.model_view.radius||Math.floor(t.w/(2.25*Math.sqrt(VIS.model_view.aspect*m)));n=Math.floor(r*2.1);a=1.1*r;i.selectAll("rect.bg").data([1]).enter().append("rect").attr("width",t.w).attr("height",t.h).classed("bg",true);if(e.type==="scaled"){v.forEach(function(e,t){v[t].x=e.scaled[0];v[t].y=e.scaled[1];v[t].r=r})}else{v.forEach(function(e,t){v[t].sort_key=e.name?view.topic.sort_name(e.name):e.words.join(" ")});v=v.sort(function(e,t){return d3.ascending(e.sort_key,t.sort_key)});view.model.grid_coords(m,VIS.model_view.cols||Math.floor(Math.sqrt(VIS.model_view.aspect*m))).forEach(function(e,t){v[t].x=e.x;v[t].y=e.y;v[t].r=r})}o=d3.extent(v,function(e){return e.x});s=d3.extent(v,function(e){return e.y});l=d3.scale.linear().domain(o).range([a,t.w-a]);d=d3.scale.linear().domain(s).range([t.h-a,a]);c=d3.scale.sqrt().domain([0,1]).range(VIS.model_view.size_range);u=d3.scale.linear().domain([0,d3.max(v,function(e){return e.total})]).range([0,VIS.model_view.stroke_range]);p=i.selectAll("g").data(v,function(e){return e.t});f=p.enter().append("g");p.exit().remove();f.append("circle").attr("cx",0).attr("cy",0).attr("r",function(e){return e.r}).classed("topic_cloud",true).attr("stroke-width",function(e){return u(e.total)}).on("click",function(e){if(!d3.event.shiftKey){set_view(topic_hash(e.t))}}).on("mouseover",function(e){p.sort(function(t,i){if(t.t===i.t){return 0}if(t.t===e.t){return 1}if(i.t===e.t){return-1}return d3.ascending(t.t,i.t)}).order();d3.select(this.parentElement).selectAll("text.topic_label").classed("hidden",false);d3.select(this.parentElement).selectAll("text.topic_name").classed("hidden",true)}).on("mouseout",function(){p.sort(function(e,t){return d3.ascending(e.t,t.t)}).order();d3.select(this.parentElement).selectAll("text.topic_label").classed("hidden",true);d3.select(this.parentElement).selectAll("text.topic_name").classed("hidden",false)});f.selectAll("text.topic_label").data(function(e){var t=e.words[0].weight,i=e.words.map(function(e){return{text:e.word,size:Math.floor(c(e.weight/t))}}),r=0,a=0,o=false,s;for(s=0;s<i.length;s+=1,o=!o){if(o){i[s].y=r;r-=i[s].size}else{a+=i[s].size;i[s].y=a}if(r-n/2<i[s].size&&a>n/2){break}}return i.slice(0,s)}).enter().append("text").classed("topic_label",true).text(function(e){return e.text}).style("font-size",function(e){return e.size+"px"}).attr("x",0).attr("y",function(e){return e.y}).classed("hidden",true);f.selectAll("text.topic_name").data(function(e){var t=view.topic.label(e.t,e.words,e.name).split(/[\s ]+/);return t.map(function(e,i){return{w:e,y:VIS.model_view.name_size*(i-(t.length-1)/2)}})}).enter().append("text").classed("topic_name",true).attr("x",0).attr("y",function(e){return e.y}).text(function(e){return e.w}).style("font-size",VIS.model_view.name_size+"px");_=function(e){var t="translate("+l(e.x);t+=","+d(e.y)+")";return t};p.transition().duration(1e3).attr("transform",_);f.transition().duration(0).attr("transform",_);if(e.type==="scaled"){w=d3.behavior.zoom().x(l).y(d).scaleExtent([1,10]).on("zoom",function(){if(VIS.zoom_transition){p.transition().duration(1e3).attr("transform",_);VIS.zoom_transition=false}else{p.attr("transform",_)}});d3.select("button#reset_zoom").on("click",function(){VIS.zoom_transition=true;w.translate([0,0]).scale(1).event(i)});w(i)}else{i.on(".zoom",null)}};view.model.grid_coords=function(e,t){var i=t||Math.floor(Math.sqrt(e)),n=Math.round(e/i),r=e-n*i,a=d3.ascending(r,0),o=[],s,l,d,c=[];s=Math.sqrt(3)/2;for(l=a===1?0:1;l<n;l+=2){o[l]=i;if(Math.abs(r)>0){o[l]+=a;r-=a}}for(l=a===1?1:0;l<n;l+=2){o[l]=i;if(Math.abs(r)>0){o[l]+=a;r-=a}}if(a===-1){o.reverse()}if(d3.sum(o)!==e){view.error("The topic grid has gone wrong. This is a bug.")}for(l=0;l<n;l+=1){for(d=0;d<o[l];d+=1){c.push({x:d+.5+(l%2===0?0:.5),y:(n-l)*s+.5})}}return c};"use strict";view.model.yearly=function(e){var t=VIS.model_view.yearly,i,n,r,a,o,s,l,d,c,u,p,f,_;i=view.plot_svg("#model_view_yearly",t);l=e.type?e.type==="raw":VIS.last.model_yearly;VIS.last.model_yearly=l;d=view.model.yearly.stacked_series({yearly_totals:e.yearly_totals,topics:e.topics,raw:l});if(!VIS.ready.model_yearly){i.append("rect").attr("width",t.w).attr("height",t.h).classed("bg",true);i.append("clipPath").attr("id","clip").append("rect").attr("x",0).attr("y",0).attr("width",t.w).attr("height",t.h);i.selectAll("path.topic_area").remove();i.selectAll("text.layer_label").remove();VIS.ready.model_yearly=true}s=function(){var e=d3.scale.category20(),t=[];d.order.forEach(function(e,i){t[e]=i});return function(i,n){var r=e(t[i]%20);return n?d3.hsl(r).brighter(.5).toString():r}}();n=d3.time.scale.utc().domain(d.domain_x).range([0,t.w]);r=d3.scale.linear().domain(d.domain_y).range([t.h,0]).nice();i.selectAll("g.axis").remove();a=d3.svg.axis().scale(n).orient("bottom");i.append("g").classed("axis",true).classed("x",true).attr("transform","translate(0,"+t.h+")").call(a);c=i.selectAll("path.topic_area").data(d.data);c.enter().append("path").classed("topic_area",true).attr("clip-path","url(#clip)").style("fill",function(e){return s(e.t)}).on("mouseover",function(e){d3.select(this).style("fill",s(e.t,true));view.tooltip().text(view.topic.label(e.t,e.words,e.name));view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(e){view.tooltip().update_pos()}).on("mouseout",function(e){d3.select(this).style("fill",s(e.t));view.tooltip().hide()}).on("click",function(e){if(!d3.event.shiftKey){set_view(topic_hash(e.t))}});u=i.selectAll("text.layer_label").data(d.data);u.enter().append("text").classed("layer_label",true).attr("clip-path","url(#clip)");p=function(e){var t,i,a,o,s=[],l=[],c=n.domain()[0],u=n.domain()[1],p=r.domain()[0],f=r.domain()[1],_=r(0);for(t=0;t<d.data.length;t+=1){s[t]=false;a=d.data[t].values;for(i=0,o=0;i<a.length;i+=1){if(a[i].x>=c&&a[i].x<=u&&a[i].y0+a[i].y>=p&&a[i].y0+a[i].y<=f){if(a[i].y>o&&_-r(a[i].y)>VIS.model_view.yearly.label_threshold){s[t]=true;l[t]=i;o=a[i].y}}}}e.attr("display",function(e){return s[e.t]?"inherit":"none"});e.filter(function(e){return s[e.t]}).attr("x",function(e){return n(e.values[l[e.t]].x)}).attr("y",function(e){return r(e.values[l[e.t]].y0+e.values[l[e.t]].y/2)}).text(function(e){var t=e.words.slice(0,VIS.model_view.yearly.label_words);return view.topic.label(e.t,t,e.name)})};d3.select("div#model_view_yearly").classed("hidden",false);o=d3.svg.area().x(function(e){return n(e.x)}).y0(function(e){return r(e.y0)}).y1(function(e){return r(e.y0+e.y)});f=function(e){return o(e.values)};c.transition().duration(2e3).attr("d",f);p(u.transition().duration(2e3));_=d3.behavior.zoom().x(n).y(r).scaleExtent([1,5]).on("zoom",function(){if(VIS.zoom_transition){c.transition().duration(2e3).attr("d",f);i.select("g.x.axis").transition().duration(2e3).call(a);p(u.transition().duration(2e3));VIS.zoom_transition=false}else{c.attr("d",f);p(u);i.select("g.x.axis").call(a)}});d3.select("button#reset_zoom").on("click",function(){VIS.zoom_transition=true;_.translate([0,0]).scale(1).event(i)});_(i);d3.select("button#yearly_raw_toggle").text(l?"Show proportions":"Show counts").on("click",function(){set_view(l?"/model/yearly/frac":"/model/yearly/raw")});d3.selectAll("#yearly_choice li").classed("active",false);d3.select(l?"#nav_model_yearly_raw":"#nav_model_yearly_frac").classed("active",true);return true};view.model.yearly.stacked_series=function(e){var t,i,n,r,a,o,s,l;if(!VIS.model_view.yearly.data){VIS.model_view.yearly.data={};t=e.yearly_totals.keys().sort();i=t.map(function(e){return new Date(Date.UTC(+e,0,1))});VIS.model_view.yearly.domain_years=d3.extent(i);n=e.topics.map(function(e){var n={t:e.t,words:e.words,name:e.name};n.values=t.map(function(t,n){var r={yr:t,x:i[n],y:e.wts.get(t)||0};return r});return n});r=d3.layout.stack().values(function(e){return e.values}).offset("wiggle").order("inside-out");o=r(n);a=r.order()(n.map(function(e){return e.values.map(function(e){return[e.x,e.y]})}));r.order(function(e){return a});s=r(n.map(function(t){return{t:t.t,words:t.words,name:t.name,values:t.values.map(function(t){return{x:t.x,y:t.y*e.yearly_totals.get(t.yr)}})}}));l=function(e){return[0,d3.max(e.map(function(e){return d3.max(e.values,function(e){return e.y0+e.y})}))]};VIS.model_view.yearly.domain_frac=l(o);VIS.model_view.yearly.domain_raw=l(s);VIS.model_view.yearly.order=a;VIS.model_view.yearly.data.frac=o;VIS.model_view.yearly.data.raw=s}return{data:VIS.model_view.yearly.data[e.raw?"raw":"frac"],domain_x:VIS.model_view.yearly.domain_years,domain_y:VIS.model_view.yearly[e.raw?"domain_raw":"domain_frac"],order:VIS.model_view.yearly.order}};"use strict";view.settings=function(e){if(VIS.ready.settings){return}d3.select("#n_words_list").property("min",1).property("max",e.max_words).property("value",VIS.overview_words).on("change",function(){VIS.overview_words=this.valueAsNumber});d3.select("#n_words_topic").property("min",1).property("max",e.max_words).property("value",VIS.topic_view.words).on("change",function(){VIS.topic_view.words=this.valueAsNumber});d3.select("#n_topic_docs").property("min",1).property("max",e.max_docs).property("value",VIS.topic_view.docs).on("change",function(){VIS.topic_view.docs=this.valueAsNumber});d3.select("#highlight_special").property("checked",VIS.special_issue_class==="special_issue").on("change",function(){var e=VIS.special_issue_class==="special_issue";if(e){VIS.special_issue_class="special_issue_nohighlight";d3.selectAll(".special_issue").classed({special_issue:false,special_issue_nohighlight:true})}else{VIS.special_issue_class="special_issue";d3.selectAll(".special_issue_nohighlight").classed({special_issue:true,special_issue_nohighlight:false})}});d3.select("#reveal_hidden").property("checked",VIS.show_hidden_topics===true).on("change",function(){VIS.show_hidden_topics=!VIS.show_hidden_topics;VIS.model_view.yearly.data=undefined;VIS.ready.model_yearly=false});VIS.ready.settings=true};"use strict";view.topic=function(e){var t=d3.select("div#topic_view");t.select("h2#topic_header").text(view.topic.label(e.t,utils.shorten(e.words,VIS.overview_words),e.name,false,true))};view.topic.remark=function(e){d3.select("#topic_view #topic_remark").text(VIS.percent_format(e.col_sum/e.total_tokens)+" of corpus")};view.topic.words=function(e){var t;if(view.updating()){return}t=d3.select("table#topic_words tbody").selectAll("tr").data(e);t.enter().append("tr");t.exit().remove();t.on("click",function(e){set_view("/word/"+e.word)});t.selectAll("td").remove();t.append("td").append("a").attr("href",function(e){return"#/word/"+e.word}).text(function(e){return e.word});view.append_weight_tds(t,function(t){return t.weight/e[0].weight})};view.topic.docs=function(e){var t,i,n=e.docs;if(e.year!==undefined){t=" in "+e.year;d3.select("#topic_year_clear").classed("disabled",false).on("click",function(){d3.select(".selected_year").classed("selected_year",false);view.updating(true);set_view(topic_hash(e.t))}).classed("hidden",false)}else{t="";d3.select("#topic_year_clear").classed("disabled",true)}d3.selectAll("#topic_docs span.topic_year").text(t);if(n===undefined||n.length===0){d3.selectAll("#topic_docs .none").classed("hidden",false);d3.select("#topic_docs table").classed("hidden",true);return true}d3.selectAll("#topic_docs .none").classed("hidden",true);d3.select("#topic_docs table").classed("hidden",false);i=d3.select("#topic_docs tbody").selectAll("tr").data(n);i.enter().append("tr");i.exit().remove();i.selectAll("td").remove();i.append("td").classed(VIS.special_issue_class,function(t,i){return!!e.specials[i]}).append("a").html(function(t,i){return e.citations[i]});i.on("click",function(e){set_view("/doc/"+e.doc)});view.append_weight_tds(i,function(e){return e.frac});i.append("td").classed("td-right",true).text(function(e){return VIS.percent_format(e.frac)});i.append("td").classed("td-right",true).text(function(e){return e.weight})};view.topic.yearly=function(e){if(!view.updating()){view.topic.yearly_barplot({t:e.t,yearly:e.yearly,svg:view.plot_svg("div#topic_plot",VIS.topic_view),axes:true,clickable:true,year:e.year,spec:VIS.topic_view})}};view.topic.yearly_barplot=function(e){var t=[],i,n,r,a,o,s,l,d=e.svg,c=e.spec;t=e.yearly.keys().sort().map(function(t){return[new Date(Date.UTC(+t,0,1)),e.yearly.get(t)]});i=d3.time.scale.utc().domain([t[0][0],d3.time.day.utc.offset(t[t.length-1][0],c.bar_width)]).range([0,c.w]);r=i(d3.time.day.utc.offset(t[0][0],c.bar_width))-i(t[0][0]);a=i(d3.time.year.utc.offset(t[0][0],1))-i(t[0][0]);n=d3.scale.linear().domain([0,d3.max(t,function(e){return e[1]})]).range([c.h,0]).nice();if(e.axes){d.selectAll("g.axis").remove();d.append("g").classed("axis",true).classed("x",true).attr("transform","translate(0,"+c.h+")").call(d3.svg.axis().scale(i).orient("bottom").ticks(d3.time.years.utc,c.ticks));d.append("g").classed("axis",true).classed("y",true).call(d3.svg.axis().scale(n).orient("left").tickSize(-c.w).outerTickSize(0).tickFormat(VIS.percent_format).ticks(c.ticks));d.selectAll("g.axis.y g").filter(function(e){return e}).classed("minor",true)}d.selectAll("g.topic_proportion").remove();o=d.selectAll("g.topic_proportion").data(t);o.enter().append("g").classed("topic_proportion",true);o.attr("transform",function(e){return"translate("+i(e[0])+",0)"});o.classed("selected_year",function(t){return String(t[0].getUTCFullYear())===e.year});if(e.clickable){s=o.append("rect").classed("interact",true).attr("x",-a/2).attr("y",0).attr("width",a).attr("height",function(e){return c.h})}o.append("rect").classed("display",true).attr("x",-r/2).attr("y",function(e){return n(e[1])}).attr("width",r).attr("height",function(e){return c.h-n(e[1])}).style("fill",e.color).style("stroke",e.color);if(e.clickable){o.on("mouseover",function(e){d3.select(this).classed("hover",true)}).on("mouseout",function(e){d3.select(this).classed("hover",false)});l=function(e){return e[0].getUTCFullYear()};s.on("mouseover",function(e){var t=d3.select(this.parentNode);t.select(".display").classed("hover",true);view.tooltip().text(l(e));view.tooltip().update_pos();view.tooltip().show()}).on("mousemove",function(e){view.tooltip().update_pos()}).on("mouseout",function(e){d3.select(this.parentNode).select(".display").classed("hover",false);view.tooltip().hide()}).on("click",function(t){
if(d3.select(this.parentNode).classed("selected_year")){d3.select(this.parentNode).classed("selected_year",false);view.tooltip().text(l(t));view.updating(true);set_view(topic_hash(e.t))}else{d3.selectAll(".selected_year").classed("selected_year",false);d3.select(this.parentNode).classed("selected_year",true);view.tooltip().text(l(t));view.updating(true);set_view(topic_hash(e.t)+"/"+t[0].getUTCFullYear())}})}};view.topic.label=function(e,t,i,n,r){var a,o,s;if(typeof i==="string"){s=i.match(/:.*$/);s=s?s[0]:"";o=i.replace(/:.*$/,"")}else{o="Topic "+String(e+1)}if(n&&t&&t.length>0){o+=s;o+=": ";for(a=0;a<t.length;a+=1){o+=" "+t[a].word}}else if(r){o+=s}return o};view.topic.sort_name=function(e){return e.replace(/^(the|a|an) /i,"").toLowerCase()};view.topic.dropdown=function(e){var t;d3.select("ul#topic_dropdown").selectAll("li.loading_message").remove();t=d3.select("ul#topic_dropdown").selectAll("li").data(e,function(e){return e.topic});t.enter().append("li").append("a").text(function(e){return view.topic.label(e.topic,e.words,e.name)}).attr("href",function(e){return topic_link(e.topic)});t.sort(function(e,t){return d3.ascending(view.topic.sort_name(e.name),view.topic.sort_name(t.name))}).order();t.classed("hidden_topic",function(e){return e.hidden})};"use strict";view.word=function(e){var t=d3.select("div#word_view"),i=e.word,n=e.n,r,a,o,s,l,d,c,u,p,f,_,w;d3.select("form#word_view_form").on("submit",function(){d3.event.preventDefault();var e=d3.select("input#word_input").property("value").toLowerCase();set_view("/word/"+e)});if(e.word===undefined){return}t.selectAll("#word_view span.word").text(i);t.selectAll("#word_view .none").classed("hidden",e.topics.length!==0);t.select("table#word_topics").classed("hidden",e.topics.length===0);t.select("#word_view_explainer").classed("hidden",e.topics.length===0);r=e.topics.map(function(t,i){var n,r=e.words[i];return r.map(function(e,t){if(t===0){n=e.weight}return{word:e.word,weight:e.weight/n}})});a={w:VIS.word_view.w,h:VIS.word_view.row_height*(e.n_topics+1),m:VIS.word_view.m};o=VIS.word_view.row_height;s=view.plot_svg("#word_view_main",a);d3.select("#word_view_main svg").attr("height",VIS.word_view.row_height*(Math.max(e.topics.length,VIS.word_view.svg_rows)+1)+a.m.top+a.m.bottom);l=d3.scale.linear().domain([0,n]).range([0,a.w]);d=d3.scale.linear().domain([0,Math.max(1,e.topics.length-1)]).range([o,o*(Math.max(e.topics.length,1)+1)]);c=d3.scale.linear().domain([0,1]).range([0,o/2]);u=s.selectAll("g.topic").data(e.topics,function(e){return e.topic});u.transition().duration(1e3).attr("transform",function(e,t){return"translate(0,"+d(t)+")"});p=u.enter().append("g").classed("topic",true).attr("transform",function(e,t){return"translate(0,"+d(t)+")"}).style("opacity",0);if(!VIS.ready.word){d3.selectAll("g.topic").style("opacity",1);VIS.ready.word=true}else{d3.transition().duration(1e3).ease("linear").each("end",function(){d3.selectAll("g.topic").style("opacity",1)})}u.exit().transition().duration(2e3).attr("transform","translate(0,"+o*(n+u.exit().size())+")").remove();p.append("rect").classed("interact",true).attr({x:-a.m.left,y:-o,width:a.m.left,height:o}).on("click",function(e){set_view(topic_hash(e.topic))});p.append("text").classed("topic",true).attr({x:-VIS.word_view.topic_label_padding,y:-(o-VIS.word_view.topic_label_size)/2}).text(function(t,i){return e.names[i]||"Topic "+(t.topic+1)}).style("font-size",VIS.word_view.topic_label_size+"pt");f=u.selectAll("g.word").data(function(e,t){return r[t]},function(e){return e.word});_=f.enter().append("g").classed("word",true);_.append("text").attr("transform","rotate(-45)");_.append("rect").classed("proportion",true).attr({x:0,y:0});f.selectAll("text").text(function(e){return e.word});f.selectAll("text, rect").on("click",function(e){set_view("/word/"+e.word)}).on("mouseover",function(){d3.select(this.parentNode).classed("hover",true)}).on("mouseout",function(){d3.select(this.parentNode).classed("hover",false)});f.classed("selected_word",function(e){return e.word===i});_.attr("transform",function(e,t){return"translate("+l(t)+",-"+o/2+")"}).attr("opacity",0);w=f.transition().duration(2e3).attr("transform",function(e,t){return"translate("+l(t)+",-"+o/2+")"}).attr("opacity",1).each("end",function(){d3.select(this).classed("update_row",false)});w.selectAll("text").attr("x",a.w/(4*n));w.selectAll("rect").attr("width",a.w/(2*n)).attr("height",function(e){return c(e.weight)});f.exit().transition().delay(1e3).remove();return true};"use strict";view.words=function(e){if(!VIS.ready.words){d3.select("ul#vocab_list").selectAll("li").data(e).enter().append("li").append("a").text(function(e){return e}).attr("href",function(e){return"#/word/"+e});VIS.ready.words=true}return true};"use strict";var VIS={ready:{},last:{bib:{}},view_updating:false,files:{info:"data/info.json",meta:"data/meta.csv.zip",dt:"data/dt.json.zip",tw:"data/tw.json",topic_scaled:"data/topic_scaled.csv"},default_view:"/model",overview_words:15,model_view:{w:1140,aspect:1.3333,words:4,size_range:[7,18],name_size:18,stroke_range:6,yearly:{w:1090,h:800,m:{left:20,right:20,top:20,bottom:20},label_threshold:40,words:4,label_words:2},list:{spark:{w:70,h:20,m:{left:2,right:2,top:2,bottom:2},bar_width:300}}},topic_view:{words:50,docs:20,w:800,h:300,m:{left:40,right:20,top:20,bottom:20},bar_width:90,ticks:10},word_view:{n_min:10,topic_label_padding:8,topic_label_size:14,row_height:80,svg_rows:10,w:1e3,m:{left:100,right:40,top:20,bottom:0}},bib:{keys:{major:["decade","year","journal","issue","alpha"],minor:["date","journal","alpha"]},author_delimiter:"	"},bib_view:{window_lines:100,major:"year",minor:"alpha",dir:"up"},float_format:function(e){return d3.round(e,3)},tooltip:{offset:{x:10,y:0}},percent_format:d3.format(".1%"),cite_date_format:d3.time.format.utc("%B %Y"),uri_proxy:"",hidden_topics:[],show_hidden_topics:false,annotes:[]};var topic_link,topic_hash,topic_view,word_view,words_view,doc_view,bib_view,about_view,settings_view,model_view,model_view_list,model_view_plot,model_view_yearly,set_view,view_refresh,hide_topics,view_loading,setup_vis,load_data,main;topic_link=function(e){return"#"+topic_hash(e)};topic_hash=function(e){return"/topic/"+String(e+1)};topic_view=function(e,t,i){var n,r,a=+t-1;if(!e.meta()||!e.has_dt()||!e.tw()){view.loading(true);return true}if(!isFinite(a)||a<0||a>=e.n()){d3.select("#topic_view_help").classed("hidden",false);d3.select("#topic_view_main").classed("hidden",true);view.loading(false);return true}r=e.valid_year(i)?i:undefined;n=utils.shorten(e.topic_words(a),VIS.topic_view.words);view.topic({t:a,words:n,name:e.topic_name(a)});d3.select("#topic_view_help").classed("hidden",true);d3.select("#topic_view_main").classed("hidden",false);e.total_tokens(function(t){e.topic_total(a,function(i){view.topic.remark({alpha:e.alpha(a),col_sum:i,total_tokens:t})})});view.topic.words(n);if(!view.updating()){d3.select("#topic_plot").classed("hidden",true)}e.topic_yearly(a,function(e){view.topic.yearly({t:a,year:r,yearly:e});d3.select("#topic_plot").classed("hidden",false)});view.calculating("#topic_docs",true);e.topic_docs(a,VIS.topic_view.docs,r,function(t){var i=t.map(function(e){return e.doc});view.calculating("#topic_docs",false);view.topic.docs({t:a,docs:t,specials:e.special_issue(i),citations:t.map(function(t){return bib.citation(e.meta(t.doc))}),year:r})});view.loading(false);return true};word_view=function(e,t){var i=d3.select("div#word_view"),n=t,r,a=0;if(!e.tw()){view.loading(true);return true}view.loading(false);if(n){i.select("#word_view_help").classed("hidden",true)}else{i.select("#word_view_help").classed("hidden",false);if(VIS.last.word){n=VIS.last.word;i.select("a#last_word").attr("href","#/word/"+n).text(document.URL.replace(/#.*$/,"")+"#/word/"+n);i.select("#last_word_help").classed("hidden",false)}else{i.select("#word_view_main").classed("hidden",true);view.word({word:undefined});return true}}i.select("#word_view_main").classed("hidden",false);VIS.last.word=n;r=e.word_topics(n).filter(function(e){return!VIS.topic_hidden[e.topic]||VIS.show_hidden_topics});if(r.length>0){a=1+d3.max(r,function(e){return e.rank});a=d3.max(r,function(t){return e.topic_words(t.topic,a).length})}a=Math.max(VIS.word_view.n_min,a);view.word({word:n,topics:r,words:r.map(function(t){return e.topic_words(t.topic,a).slice(0,a)}),n:a,n_topics:e.n(),names:r.map(function(t){return e.topic_name(t.topic)})});return true};words_view=function(e){if(!e.tw()){view.loading(true);return true}view.loading(false);return view.words(e.vocab())};doc_view=function(e,t){var i=d3.select("div#doc_view"),n=+t;if(!e.meta()||!e.has_dt()||!e.tw()){view.loading(true);return true}view.loading(false);if(!isFinite(n)||n<0||n>=e.n_docs()){d3.select("#doc_view_help").classed("hidden",false);if(VIS.last.doc===undefined){d3.select("#doc_view_main").classed("hidden",true);return true}n=VIS.last.doc;i.select("a#last_doc").attr("href","#/doc/"+n).text(document.URL.replace(/#.*$/,"")+"#/doc/"+n);i.select("#last_doc_help").classed("hidden",false)}else{d3.select("#doc_view_help").classed("hidden",true);VIS.last.doc=n}d3.select("#doc_view_main").classed("hidden",false);view.calculating("#doc_view",true);e.doc_topics(n,e.n(),function(t){var i=t.filter(function(e){return!VIS.topic_hidden[e.topic]||VIS.show_hidden_topics});view.calculating("#doc_view",false);view.doc({topics:i,meta:e.meta(n),special:e.special_issue(n),total_tokens:d3.sum(i,function(e){return e.weight}),words:i.map(function(t){return e.topic_words(t.topic,VIS.overview_words)}),names:i.map(function(t){return e.topic_name(t.topic)})});hide_topics()});return true};bib_view=function(e,t,i,n){var r={major:t,minor:i,dir:n},a,o;if(!e.meta()){view.loading(true);return true}r=bib.sort.validate(r);if(r.minor===undefined){if(r.major===undefined){r.minor=VIS.last.bib.minor||VIS.bib_view.minor}else{r.minor=VIS.bib_view.minor}}if(r.major===undefined){r.major=VIS.last.bib.major||VIS.bib_view.major}if(r.dir===undefined){r.dir=VIS.last.bib.dir||VIS.bib_view.dir}VIS.last.bib=r;a=bib.sort.dir(r);o=bib.sort(e,r.major,r.minor,a.major,a.minor);if(!VIS.ready.bib){VIS.bib_citations=e.meta().map(bib.citation);VIS.ready.bib=true}view.bib({ordering:o,major:r.major,minor:r.minor,dir:r.dir,citations:VIS.bib_citations,specials:e.special_issue()});view.loading(false);VIS.ready.bib=true;return true};about_view=function(e,t){view.about(t);view.loading(false);d3.select("#about_view").classed("hidden",false);return true};settings_view=function(e){var t={max_words:e.n_top_words(),max_docs:e.n_docs()};if(t.max_words===undefined||t.max_docs===undefined){return false}view.settings(t);view.loading(false);d3.select("#settings_view").classed("hidden",false);return true};model_view=function(e,t,i,n){var r=t||VIS.last.model||"grid";if(!e.tw()||!e.topic_scaled()){view.loading(true);return true}d3.selectAll("#nav_model li.active").classed("active",false);d3.select("#nav_model_"+r).classed("active",true);d3.select("#model_view_plot").classed("hidden",true);d3.select("#model_view_list").classed("hidden",true);d3.select("#model_view_yearly").classed("hidden",true);d3.selectAll(".model_view_grid").classed("hidden",true);d3.selectAll(".model_view_scaled").classed("hidden",true);d3.selectAll(".model_view_list").classed("hidden",true);d3.selectAll(".model_view_yearly").classed("hidden",true);d3.select("#model_view nav").classed("hidden",false);if(r==="list"){if(!e.meta()||!e.has_dt()){view.loading(true);return true}model_view_list(e,i,n);d3.select("#model_view_list").classed("hidden",false)}else if(r==="yearly"){if(!e.meta()||!e.has_dt()){view.loading(true);return true}model_view_yearly(e,i);d3.select("#model_view_yearly").classed("hidden",false)}else{if(!e.topic_scaled()||!e.has_dt()){view.loading(true);return true}if(r!=="scaled"||e.topic_scaled().length!==e.n()){r="grid"}model_view_plot(e,r);d3.select("#model_view_plot").classed("hidden",false)}VIS.last.model=r;d3.selectAll(".model_view_"+r).classed("hidden",false);view.loading(false);return true};model_view_list=function(e,t,i){view.calculating("#model_view_list",true);e.topic_total(undefined,function(n){e.topic_yearly(undefined,function(r){view.calculating("#model_view_list",false);view.model.list({yearly:r,sums:n,words:e.topic_words(undefined,VIS.overview_words),sort:t,dir:i,names:d3.range(e.n()).map(e.topic_name),topic_hidden:VIS.topic_hidden});hide_topics()})});return true};model_view_plot=function(e,t){e.topic_total(undefined,function(i){var n=d3.range(e.n());if(!VIS.show_hidden_topics){n=n.filter(function(e){return!VIS.topic_hidden[e]})}view.model.plot({type:t,topics:n.map(function(t){return{t:t,words:e.topic_words(t,VIS.model_view.words),scaled:e.topic_scaled(t),total:i[t],name:e.topic_name(t)}})})});return true};model_view_yearly=function(e,t){var i={type:t};if(VIS.ready.model_yearly){view.model.yearly(i);return true}view.calculating("#model_view_yearly",true);e.yearly_total(undefined,function(t){e.topic_yearly(undefined,function(n){i.yearly_totals=t;i.topics=n.map(function(t,i){return{t:i,wts:t,words:e.topic_words(i,VIS.model_view.yearly.words),name:e.topic_name(i)}}).filter(function(e){return VIS.show_hidden_topics||!VIS.topic_hidden[e.t]});view.model.yearly(i);view.calculating("#model_view_yearly",false)})});return true};set_view=function(e){window.location.hash=e};view_refresh=function(e,t){var i,n,r,a,o;i=t.split("/");if(i[i.length-1]==="no_intro"){i.length-=1}if(VIS.cur_view!==undefined&&!view.updating()){VIS.cur_view.classed("hidden",true)}if(i[0]!=="#"){i=VIS.default_view.split("/")}n=i[1];r=i.slice(2,i.length);r.unshift(e);switch(n){case"model":a=model_view.apply(undefined,r);break;case"about":a=about_view.apply(undefined,r);break;case"settings":a=settings_view(e);break;case"bib":a=bib_view.apply(undefined,r);break;case"topic":a=topic_view.apply(undefined,r);break;case"word":a=word_view.apply(undefined,r);break;case"doc":a=doc_view.apply(undefined,r);break;case"words":a=words_view.apply(undefined,r);break;default:a=false;break}if(a){VIS.cur_view=d3.select("div#"+n+"_view");VIS.annotes.forEach(function(e){d3.selectAll(e).classed("hidden",true)});VIS.annotes=[".view_"+n];for(o=1;o<r.length;o+=1){VIS.annotes[o]=VIS.annotes[o-1]+"_"+r[o]}VIS.annotes.forEach(function(e){d3.selectAll(e).classed("hidden",false)})}else{if(VIS.cur_view===undefined){VIS.cur_view=d3.select("div#model_view");model_view(e)}}view.updating(false);hide_topics();VIS.cur_view.classed("hidden",false);d3.selectAll("#nav_toplevel li.active").classed("active",false);d3.select("li#nav_"+i[1]).classed("active",true)};hide_topics=function(e){var t=e===undefined?!VIS.show_hidden_topics:e;d3.selectAll(".hidden_topic").classed("hidden",function(){return t})};setup_vis=function(e){if(e.info()){VIS=utils.deep_replace(VIS,e.info().VIS);d3.selectAll(".model_title").html(e.info().title)}window.onhashchange=function(){view_refresh(e,window.location.hash,false)};d3.select("#nav_help").on("click",function(){var e=d3.select("#help_box"),t=e.classed("hidden");e.classed("hidden",!t);d3.select("#nav_help").classed("active",t)});$("#settings_modal").on("hide.bs.modal",function(){view_refresh(e,window.location.hash)})};load_data=function(e,t){var i,n;if(e===undefined){return t("target undefined",undefined)}i=e.replace(/^.*\//,"");n="m__DATA__"+i.replace(/\..*$/,"");if(document.getElementById(n)){return t(undefined,document.getElementById(n).innerHTML)}if(e.search(/\.zip$/)>0){return d3.xhr(e).responseType("arraybuffer").get(function(e,n){var r,a;if(n&&n.status===200){r=new JSZip(n.response);a=r.file(i.replace(/\.zip$/,"")).asText()}return t(e,a)})}return d3.text(e,function(e,i){return t(e,i)})};main=function(){load_data(VIS.files.info,function(e,t){var i=model();if(typeof t==="string"){i.info(JSON.parse(t))}else{view.warning("Unable to load model info from "+VIS.files.info)}setup_vis(i);load_data(VIS.files.meta,function(e,t){if(typeof t==="string"){i.set_meta(t);view_refresh(i,window.location.hash)}else{view.error("Unable to load metadata from "+VIS.files.meta)}});load_data(VIS.files.dt,function(e,t){i.set_dt(t,function(e){if(e){view_refresh(i,window.location.hash)}else{view.error("Unable to load document topics from "+VIS.files.dt)}})});load_data(VIS.files.tw,function(e,t){if(typeof t==="string"){i.set_tw(t);VIS.topic_hidden=d3.range(i.n()).map(function(e){return VIS.hidden_topics.indexOf(e+1)!==-1});view.topic.dropdown(d3.range(i.n()).map(function(e){return{topic:e,words:i.topic_words(e,VIS.model_view.words),name:i.topic_name(e),hidden:VIS.topic_hidden[e]}}));view_refresh(i,window.location.hash)}else{view.error("Unable to load topic words from "+VIS.files.tw)}});load_data(VIS.files.topic_scaled,function(e,t){if(typeof t==="string"){i.set_topic_scaled(t)}else{i.set_topic_scaled("");d3.select("#nav_model_scaled").classed("disabled",true).select("a").attr("href","#/model/scaled")}view_refresh(i,window.location.hash)});view_refresh(i,window.location.hash)})};