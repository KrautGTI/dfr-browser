"use strict";importScripts("utils.min.js");var my={},doc_topics_matrix,total_tokens,topic_docs,doc_topics,topic_yearly,yearly_total;doc_topics_matrix=function(t){var e={},a=t;if(a.p&&a.p.length){a.n=a.p.length-1}a.get=function(t,e){var a,s,i,o;if(!this.x){return undefined}if(t===undefined){return this}if(e===undefined){o=[];for(i=0;i<this.n;i+=1){o.push(this.get(t,i))}return o}a=this.p[e];s=utils.bisect_left(this.i.slice(a,this.p[e+1]),t);o=this.i[s+a]===t?this.x[s+a]:0;return o};a.row_sum=function(t){var a,s;if(!this.x){return undefined}if(!e.row_sum){e.row_sum=[]}if(!e.row_sum[t]){a=0;for(s=0;s<this.n;s+=1){a+=this.get(t,s)}e.row_sum[t]=a}return e.row_sum[t]};a.col_sum=function(t){var a;if(!e.col_sum){e.col_sum=[]}if(t===undefined){for(a=0;a<=this.n;a+=1){this.col_sum(a)}return e.col_sum}if(!e.col_sum[t]){e.col_sum[t]=0;for(a=this.p[t];a<this.p[t+1];a+=1){e.col_sum[t]+=this.x[a]}}return e.col_sum[t]};return a};total_tokens=function(){var t,e=0;for(t=0;t<my.dt.x.length;t+=1){e+=my.dt.x[t]}return e};topic_docs=function(t,e){var a=my.dt.p[t],s=my.dt.p[t+1],i,o=[],r,d,n,c=[];for(i=a;i<s;i+=1){o.push({doc:my.dt.i[i],frac:my.dt.x[i]/my.dt.row_sum(my.dt.i[i]),weight:my.dt.x[i]})}if(e>=o.length){o.sort(function(t,e){return utils.desc(t.frac,e.frac)||utils.desc(t.doc,e.doc)});return o}c=o.slice(0,e).sort(function(t,e){return utils.asc(t.frac,e.frac)||utils.asc(t.doc,e.doc)});r=utils.bisector_left(function(t){return t.frac});for(n=e;n<o.length;n+=1){d=r(c,o[n].frac);if(d>0){c.splice(d,0,o[n]);c.shift()}else if(c[0].frac===o[n].frac){c.unshift(o[n])}}return utils.shorten(c.reverse(),e,function(t,e){return t[e].frac})};doc_topics=function(t,e){var a=[],s,i;for(s=0;s<my.dt.n;s+=1){i=my.dt.get(t,s);if(i>0){a.push({topic:s,weight:i})}}a.sort(function(t,e){return utils.desc(t.weight,e.weight)||utils.desc(t.t,e.t)});return utils.shorten(a,e,function(t,e){return t[e].weight})};topic_yearly=function(t){var e,a,s;if(!my.topic_yearly){my.topic_yearly=[]}if(t===undefined){e=[];for(a=0;a<my.dt.n;a+=1){e.push(topic_yearly(a))}return e}if(my.topic_yearly[t]){return my.topic_yearly[t]}e=[];for(a=my.dt.p[t];a<my.dt.p[t+1];a+=1){s=my.doc_years[my.dt.i[a]];if(e[s]){e[s]+=my.dt.x[a]}else{e[s]=my.dt.x[a]}}e.forEach(function(t,a){e[a]/=yearly_total(a)});my.topic_yearly[t]=e;return e};yearly_total=function(t){var e,a,s;if(!my.yearly_total){e=[];for(s=0;s<my.dt.i.length;s+=1){a=my.doc_years[my.dt.i[s]];if(e[a]){e[a]+=my.dt.x[s]}else{e[a]=my.dt.x[s]}}my.yearly_total=e}return isFinite(t)?my.yearly_total[t]:my.yearly_total};onmessage=function(t){if(t.data.what==="set_dt"){my.dt=doc_topics_matrix(t.data.dt);postMessage({what:"set_dt",result:my.dt!==undefined})}else if(t.data.what==="set_doc_years"){my.doc_years=t.data.doc_years;postMessage({what:"set_doc_years",result:my.doc_years!==undefined})}else if(t.data.what==="total_tokens"){postMessage({what:"total_tokens",result:total_tokens()})}else if(t.data.what==="topic_docs"){postMessage({what:"topic_docs/"+t.data.t+"/"+t.data.n,result:topic_docs(t.data.t,t.data.n)})}else if(t.data.what==="doc_topics"){postMessage({what:"doc_topics/"+t.data.d+"/"+t.data.n,result:doc_topics(t.data.d,t.data.n)})}else if(t.data.what==="topic_total"){postMessage({what:"topic_total/"+t.data.t,result:my.dt.col_sum(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="topic_yearly"){postMessage({what:"topic_yearly/"+t.data.t,result:topic_yearly(t.data.t==="all"?undefined:t.data.t)})}else if(t.data.what==="yearly_total"){postMessage({what:"yearly_total/"+t.data.y,result:yearly_total(t.data.y==="all"?undefined:t.data.y)})}else{postMessage({what:"error"})}};